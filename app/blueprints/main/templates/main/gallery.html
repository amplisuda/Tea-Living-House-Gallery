{% extends 'base.html' %}

{% block content %}

<main>
  <div class="container">

<form class="oz-search" action="{{ url_for('main.gallery') }}" method="GET">
  <div class="oz-search-wrap">
    <select name="category_id" class="oz-search-select" onchange="this.form.submit()">
      <option value="all" {{ 'selected' if selected_category == 'all' else '' }}>Все категории</option>

      {% for parent in category_tree %}
        <option value="{{ parent.id }}"
          {{ 'selected' if selected_category == parent.id|string else '' }}>
          {{ parent.name }} — все
        </option>
        {% for child in parent.children %}
          <option value="{{ child.id }}"
            {{ 'selected' if selected_category == child.id|string else '' }}>
            &nbsp;&nbsp;{{ child.name }}
          </option>
        {% endfor %}
      {% endfor %}
    </select>
  </div>
</form>

    <section class="oz-gallery" aria-labelledby="oz-title">
      <h1 id="oz-title" class="oz-vh">Галерея</h1>
      <div class="oz-grid" aria-label="Список товаров">
        {% for p in products_page %}
          {% set cover = (p.main_url if p.image_url and p.image_url|length>0 else url_for('static', filename='img/placeholder.png')) %}
          {% set title_line = (p.name|string).replace('\n',' ') %}
            <a href="{{ url_for('product.product', hash=p.hash) }}" class="oz-card-link">
          <article class="oz-card" tabindex="0" role="button"
                   aria-label="Открыть карточку {{ title_line }}"
                   data-oz-open="oz-modal-{{ p.id }}">
            <figure class="oz-card-media">
              <img src="{{ cover }}" loading="lazy" decoding="async" alt="{{ title_line }}" />
              <figcaption class="oz-card-cap">
                <span class="oz-card-title" title="{{ title_line }}">{{ title_line }}</span>
              </figcaption>
            </figure>
          </article>
                </a>
        {% endfor %}
      </div>

      {% if total_pages and total_pages>1 %}
      <nav class="oz-pager" aria-label="Навигация по страницам">
        <a class="oz-page {% if page<=1 %}oz-disabled{% endif %}"
           href="{{ url_for('main.gallery', page=page-1) if page>1 else '#' }}"
           aria-disabled="{{ 'true' if page<=1 else 'false' }}" rel="prev">Назад</a>

        <ul class="oz-page-list">
          {% set start=[1,page-2]|max %}
          {% set end=[total_pages,page+2]|min %}
          {% if start>1 %}
            <li><a class="oz-page" href="{{ url_for('main.gallery', page=1) }}">1</a></li>
            {% if start>2 %}<li class="oz-ellipsis">…</li>{% endif %}
          {% endif %}
          {% for n in range(start,end+1) %}
            {% if n==page %}<li><span class="oz-page oz-current" aria-current="page">{{ n }}</span></li>
            {% else %}<li><a class="oz-page" href="{{ url_for('main.gallery', page=n) }}">{{ n }}</a></li>{% endif %}
          {% endfor %}
          {% if end<total_pages %}
            {% if end<total_pages-1 %}<li class="oz-ellipsis">…</li>{% endif %}
            <li><a class="oz-page" href="{{ url_for('main.gallery', page=total_pages) }}">{{ total_pages }}</a></li>
          {% endif %}
        </ul>


        <a class="oz-page {% if page>=total_pages %}oz-disabled{% endif %}"
           href="{{ url_for('main.gallery', page=page+1) if page<total_pages else '#' }}"
           aria-disabled="{{ 'true' if page>=total_pages else 'false' }}" rel="next">Вперёд</a>
      </nav>
      {% endif %}
    </section>

    <script>
    (() => {
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

        card.addEventListener('click', open);
        card.addEventListener('keydown', e => {
          if (e.key==='Enter'||e.key===' ') { e.preventDefault(); open(); }
        });

        $('.oz-x', dlg)?.addEventListener('click', close);
        dlg.addEventListener('click', e => {
          const frame = $('.oz-modal-frame', dlg);
          if (frame && !frame.contains(e.target)) close();
        });

        $$('.oz-thumb', dlg).forEach(btn => {
          btn.addEventListener('click', () => {
            const src = btn.getAttribute('data-oz-src');
            const hero = $('[data-oz-hero]', dlg);
            if (src && hero) hero.src = src;
          });
        });
      });
    })();
    </script>

  </div>
</main>

<footer><div class="container"></div></footer>
</body>
</html>
{% endblock %}
