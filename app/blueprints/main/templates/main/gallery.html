{% extends 'base.html' %}

{% block content %}

<nav>
  <ul class="category-list"></ul>
</nav>

<main>
  <div class="container">
    <section class="oz-gallery" aria-labelledby="oz-title">
      <h1 id="oz-title" class="oz-vh">Галерея</h1>

      <div class="oz-grid" aria-label="Список товаров">
        {% for p in products_page %}
          {% set cover = (p.image_url[0] if p.image_url and p.image_url|length>0 else url_for('static', filename='img/placeholder.png')) %}
          {% set title_line = (p.name|string).replace('\n',' ') %}
          <article class="oz-card" tabindex="0" role="button"
                   aria-label="Открыть карточку {{ title_line }}"
                   data-oz-open="oz-modal-{{ p.id }}">
            <figure class="oz-card-media">
              <img src="{{ cover }}" loading="lazy" decoding="async" alt="{{ title_line }}" />
              <figcaption class="oz-card-cap">
                <span class="oz-card-title" title="{{ title_line }}">{{ title_line }}</span>
              </figcaption>
            </figure>
          </article>

          <!-- ===== МОДАЛКА ===== -->
          <dialog class="oz-modal" id="oz-modal-{{ p.id }}" aria-labelledby="oz-modal-title-{{ p.id }}">
            <form method="dialog" class="oz-modal-frame">
              <button class="oz-x" aria-label="Закрыть">✕</button>

              <div class="oz-modal-wrap">
                <div class="oz-modal-media">
                  <img class="oz-hero" src="{{ cover }}" alt="{{ title_line }}" data-oz-hero />
                  {% if p.image_url and p.image_url|length>1 %}
                    <div class="oz-thumbs" role="list">
                      {% for img in p.image_url %}
                        <button type="button" class="oz-thumb" role="listitem" data-oz-thumb data-oz-src="{{ img }}">
                          <img src="{{ img }}" loading="lazy" alt="Превью {{ loop.index }} — {{ title_line }}">
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="oz-modal-info">
                  {% if p.description is defined and (p.description|string|trim) %}
                    <div class="oz-desc">{{ p.description }}</div>
                  {% endif %}

                  <div class="oz-actions">
  <a
    class="oz-btn"
    target="_blank" rel="noopener"
    href="https://t.me/amplisuda?text={{ (
      'Здравствуйте, хотел бы приобрести картину: ' ~ url_for('product.product', hash=p.hash, _external=True)
    ) | urlencode }}"
  >
    Написать в Telegram
  </a>
</div>
                </div>
              </div>
            </form>
          </dialog>
        {% endfor %}
      </div>

      {% if total_pages and total_pages>1 %}
      <nav class="oz-pager" aria-label="Навигация по страницам">
        <a class="oz-page {% if page<=1 %}oz-disabled{% endif %}"
           href="{{ url_for('main.gallery', page=page-1) if page>1 else '#' }}"
           aria-disabled="{{ 'true' if page<=1 else 'false' }}" rel="prev">Назад</a>

        <ul class="oz-page-list">
          {% set start=[1,page-2]|max %}
          {% set end=[total_pages,page+2]|min %}
          {% if start>1 %}
            <li><a class="oz-page" href="{{ url_for('main.gallery', page=1) }}">1</a></li>
            {% if start>2 %}<li class="oz-ellipsis">…</li>{% endif %}
          {% endif %}
          {% for n in range(start,end+1) %}
            {% if n==page %}<li><span class="oz-page oz-current" aria-current="page">{{ n }}</span></li>
            {% else %}<li><a class="oz-page" href="{{ url_for('main.gallery', page=n) }}">{{ n }}</a></li>{% endif %}
          {% endfor %}
          {% if end<total_pages %}
            {% if end<total_pages-1 %}<li class="oz-ellipsis">…</li>{% endif %}
            <li><a class="oz-page" href="{{ url_for('main.gallery', page=total_pages) }}">{{ total_pages }}</a></li>
          {% endif %}
        </ul>

        <a class="oz-page {% if page>=total_pages %}oz-disabled{% endif %}"
           href="{{ url_for('main.gallery', page=page+1) if page<total_pages else '#' }}"
           aria-disabled="{{ 'true' if page>=total_pages else 'false' }}" rel="next">Вперёд</a>
      </nav>
      {% endif %}
    </section>

    <!-- ===== JS (изолирован) ===== -->
    <script>
    (() => {
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      $$('.oz-card').forEach(card => {
        const id = card.getAttribute('data-oz-open');
        const dlg = id ? document.getElementById(id) : null;
        if (!dlg) return;

        const open = () => (dlg.showModal ? dlg.showModal() : dlg.setAttribute('open','open'));
        const close = () => (dlg.close ? dlg.close() : dlg.removeAttribute('open'));

        card.addEventListener('click', open);
        card.addEventListener('keydown', e => {
          if (e.key==='Enter'||e.key===' ') { e.preventDefault(); open(); }
        });

        $('.oz-x', dlg)?.addEventListener('click', close);
        dlg.addEventListener('click', e => {
          const frame = $('.oz-modal-frame', dlg);
          if (frame && !frame.contains(e.target)) close();
        });

        $$('.oz-thumb', dlg).forEach(btn => {
          btn.addEventListener('click', () => {
            const src = btn.getAttribute('data-oz-src');
            const hero = $('[data-oz-hero]', dlg);
            if (src && hero) hero.src = src;
          });
        });
      });
    })();
    </script>

    <!-- ===== СТИЛИ (изолированы) ===== -->
    <style>
/* =======================
   THEME / TOKENS (light)
   ======================= */
:root{
  --oz-bg:#f7f7fb;
  --oz-bg-soft:#ffffff;
  --oz-surface:#fff;
  --oz-text:#0f1115;
  --oz-muted:#616977;
  --oz-accent:#5b66ff;
  --oz-ring:#5b66ff;
  --oz-border:#e7e9ef;

  --oz-radius:16px;
  --oz-radius-lg:18px;
  --oz-radius-pill:999px;

  --oz-gap:1rem;
  --oz-gap-lg:1.25rem;

  --oz-shadow:0 10px 30px rgba(17,21,27,.08), 0 1px 0 rgba(17,21,27,.05) inset;
  --oz-shadow-soft:0 4px 12px rgba(17,21,27,.06);
  --oz-shadow-focus:0 0 0 3px rgba(91,102,255,.25);
}

/* =======================
   BASE
   ======================= */
html,body{height:100%}
body{
  margin:0;
  color:var(--oz-text);
  background:linear-gradient(180deg,var(--oz-bg) 0%, var(--oz-bg-soft) 100%);
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

.container{max-width:1200px;margin:0 auto;padding:2rem 1.25rem}
.oz-vh{position:absolute!important;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}

/* =======================
   GALLERY GRID
   ======================= */
.oz-gallery{display:grid;gap:var(--oz-gap-lg);padding:1rem 0}
.oz-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:clamp(.8rem,2vw,1.1rem)}

/* =======================
   CARD
   ======================= */
.oz-card{
  cursor:pointer;
  outline:none;
  border-radius:var(--oz-radius);
  background:var(--oz-surface);
  box-shadow:var(--oz-shadow-soft);
  transition:transform .18s ease, box-shadow .18s ease;
  will-change:transform;
}
.oz-card:focus{box-shadow:var(--oz-shadow-focus)}
.oz-card:hover{transform:translateY(-2px);box-shadow:var(--oz-shadow)}

.oz-card-media{
  position:relative;
  aspect-ratio:4/5;
  overflow:hidden;
  background:#f0f1f6;
}
.oz-card-media>img{
  width:100%;height:100%;object-fit:cover;display:block;
  transform:scale(1.002);
  transition:transform .35s ease;
}
.oz-card:hover .oz-card-media>img{transform:scale(1.04)}

.oz-card-cap{
  position:absolute;left:0;right:0;bottom:0;
  padding:.65rem .7rem .7rem;
  box-sizing:border-box;
  background:linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.8) 60%, rgba(255,255,255,1) 100%);
  transform:translateY(110%);
  transition:transform .2s ease;
}
.oz-card:hover .oz-card-cap,
.oz-card:focus .oz-card-cap{transform:translateY(0)}

.oz-card-title{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  font-size:.95rem;
  font-weight:800;
  line-height:1.25;
  letter-spacing:.01em;
  color:var(--oz-text);
}

/* =======================
   MODAL
   ======================= */
dialog.oz-modal{
  border:none;padding:0;margin:auto;
  max-width:min(1000px,96vw);
  width:96vw;
  background:transparent;
}
.oz-modal::backdrop{background:rgba(0,0,0,.45)}

.oz-modal-frame{
  margin:0;background:var(--oz-surface);
  border-radius:var(--oz-radius-lg);
  overflow:hidden;position:relative;
  box-shadow:var(--oz-shadow);
}

.oz-x{
  position:absolute;top:.8rem;right:.8rem;
  border:none;background:var(--oz-text);color:#fff;
  width:36px;height:36px;border-radius:50%;
  cursor:pointer;display:grid;place-items:center;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
.oz-x:hover{filter:brightness(.9)}

.oz-modal-wrap{
  display:grid;gap:1rem;
  grid-template-columns:1fr 1fr;
  padding:1rem;
  max-height:80vh;overflow:auto;
}
@media (max-width:860px){.oz-modal-wrap{grid-template-columns:1fr}}

.oz-modal-media{display:grid;gap:.75rem}
.oz-hero{
  width:100%;aspect-ratio:4/5;object-fit:cover;
  border-radius:calc(var(--oz-radius) - 4px);
  background:#f0f1f6;
}

.oz-thumbs{display:grid;grid-auto-flow:column;gap:.5rem;overflow-x:auto;padding-bottom:.25rem}
.oz-thumb{
  border:1px solid var(--oz-border);
  background:transparent;padding:0;cursor:pointer;
  border-radius:12px;transition:transform .14s ease, border-color .14s ease;
}
.oz-thumb:hover{transform:translateY(-1px);border-color:var(--oz-accent)}
.oz-thumb img{display:block;width:74px;height:74px;object-fit:cover;border-radius:10px}

.oz-modal-info{display:grid;gap:.85rem;align-content:start}
.oz-desc{white-space:pre-wrap;line-height:1.45;color:var(--oz-text)}
.oz-modal-title{margin:0;font-size:1.25rem;font-weight:900;line-height:1.2}

/* =======================
   BUTTONS / ACTIONS
   ======================= */
.oz-actions{margin-top:.25rem}
.oz-btn{
  padding:.7rem 1rem;
  border-radius:var(--oz-radius);
  border:1px solid var(--oz-accent);
  background:var(--oz-accent);
  color:#fff;
  font-weight:700;
  text-decoration:none;
  display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
  transition:transform .1s ease, filter .1s ease, box-shadow .1s ease;
  box-shadow:0 6px 16px rgba(91,102,255,.25);
}
.oz-btn:hover{filter:brightness(0.96);transform:translateY(-1px)}
.oz-btn:active{transform:translateY(0)}
.oz-ghost{background:#fff;color:var(--oz-text);border-color:var(--oz-border);box-shadow:none}

/* =======================
   PAGER
   ======================= */
.oz-pager{display:grid;grid-auto-flow:column;gap:1rem;justify-content:center;align-items:center;padding:.75rem 0 0}
.oz-page-list{display:flex;gap:.35rem;padding:0;margin:0;list-style:none}
.oz-page,.oz-current{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:40px;height:40px;padding:0 .6rem;border-radius:12px;
  border:1px solid var(--oz-border);
  text-decoration:none;color:var(--oz-text);
  background:var(--oz-surface);
}
.oz-current{background:var(--oz-accent);color:#fff;border-color:transparent;box-shadow:0 6px 16px rgba(91,102,255,.25)}
.oz-ellipsis{padding:0 .5rem;user-select:none;color:var(--oz-muted)}
.oz-disabled{opacity:.45;pointer-events:none}

/* =======================
   ACCESSIBILITY / MISC
   ======================= */
*:focus-visible{outline:none;box-shadow:var(--oz-shadow-focus)}
img{max-width:100%;height:auto}
a{color:inherit}
    </style>
  </div>
</main>

<footer><div class="container"></div></footer>
</body>
</html>
{% endblock %}